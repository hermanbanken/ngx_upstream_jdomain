version: "3.7"
services:
  nginx:
    build:
      context: ..
    volumes:
      - ./config/conf.d:/etc/nginx/conf.d
      - ./config/nginx.conf:/etc/nginx/nginx.conf
    networks: { "main": {} }
    depends_on: ["host1"]
    ports:
    - "8085:80"
  host1:
    image: nginx:1.17.4-alpine
    networks: { "main": { "aliases": ["backendalias"] } }
    volumes: ["./config/conf.d/default.conf:/etc/nginx/conf.d/default.conf"]
    ports:
      - "8084:80"
  host2:
    image: nginx:1.17.4-alpine
    environment: ["INSTANCE=2"]
    networks: { "main": { "aliases": ["backendalias"] } }
    volumes: ["./config/conf.d/default.conf:/etc/nginx/conf.d/default.conf"]
  host3:
    image: nginx:1.17.4-alpine
    environment: ["INSTANCE=3"]
    networks: { "main": { "aliases": ["backendalias"] } }
    volumes: ["./config/conf.d/default.conf:/etc/nginx/conf.d/default.conf"]
  host4:
    image: nginx:1.17.4-alpine
    environment: ["INSTANCE=4"]
    networks: { "main": { "aliases": ["backendalias"] } }
    volumes: ["./config/conf.d/default.conf:/etc/nginx/conf.d/default.conf"]
  test:
    build:
      context: .
    networks: { "main": {} }
networks:
  main: